generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
  schemas   = ["housing"]
}

model User {
  id           String   @id @default(uuid())
  username     String   @unique
  passwordHash String   @map("password_hash")
  displayName  String   @map("display_name")
  isAdmin      Boolean  @default(false) @map("is_admin")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  preferences         UserPreferences?
  listings            Listing[]
  listingScores       ListingScore[]
  areaRecommendations AreaRecommendation[]
  viewings            Viewing[]
  dismissedAreas      DismissedArea[]
  areaNotes           AreaNote[]

  @@map("users")
  @@schema("housing")
}

model UserPreferences {
  id                 String   @id @default(uuid())
  userId             String   @unique @map("user_id")
  naturalLight       Boolean  @default(false) @map("natural_light")
  bedroomsMin        Int      @default(1) @map("bedrooms_min")
  bedroomsMax        Int      @default(2) @map("bedrooms_max")
  outdoorsAccess     Boolean  @default(false) @map("outdoors_access")
  publicTransport    Boolean  @default(false) @map("public_transport")
  budgetMin          Int      @default(1500) @map("budget_min")
  budgetMax          Int      @default(2500) @map("budget_max")
  petFriendly        Boolean  @default(false) @map("pet_friendly")
  moveInDateStart    DateTime? @map("move_in_date_start")
  moveInDateEnd      DateTime? @map("move_in_date_end")
  laundryInUnit      Boolean  @default(false) @map("laundry_in_unit")
  parking            Boolean  @default(false)
  quietNeighbourhood Boolean  @default(false) @map("quiet_neighbourhood")
  modernFinishes     Boolean  @default(false) @map("modern_finishes")
  storageSpace       Boolean  @default(false) @map("storage_space")
  gymAmenities       Boolean  @default(false) @map("gym_amenities")
  customDesires      Json     @default("[]") @map("custom_desires")
  onboardingComplete Boolean  @default(false) @map("onboarding_complete")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
  @@schema("housing")
}

enum ListingStatus {
  ACTIVE
  ARCHIVED
  REJECTED
  FAVORITE

  @@map("listing_status")
  @@schema("housing")
}

model Listing {
  id             String        @id @default(uuid())
  addedBy        String        @map("added_by")
  title          String
  description    String        @default("")
  url            String        @default("")
  address        String        @default("")
  latitude       Float?
  longitude      Float?
  price          Int?
  bedrooms       Int?
  bathrooms      Int?
  petFriendly    Boolean?      @map("pet_friendly")
  squareFeet     Int?          @map("square_feet")
  photos         Json          @default("[]")
  scrapedContent String?       @map("scraped_content")
  status         ListingStatus @default(ACTIVE)
  notes          String?
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  addedByUser User           @relation(fields: [addedBy], references: [id])
  scores      ListingScore[]
  viewings    Viewing[]

  @@map("listings")
  @@schema("housing")
}

model ListingScore {
  id                  String   @id @default(uuid())
  listingId           String   @map("listing_id")
  userId              String   @map("user_id")
  aiOverallScore      Float?   @map("ai_overall_score")
  aiBreakdown         Json?    @map("ai_breakdown")
  aiSummary           String?  @map("ai_summary")
  manualOverrideScore Float?   @map("manual_override_score")
  evaluatedAt         DateTime? @map("evaluated_at")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([listingId, userId])
  @@map("listing_scores")
  @@schema("housing")
}

model AreaRecommendation {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  areaName        String   @map("area_name")
  matchScore      Float    @map("match_score")
  reasoning       String
  keyHighlights   Json     @map("key_highlights")
  averageRent     String?  @map("average_rent")
  transitScore    String?  @map("transit_score")
  vibeDescription String?  @map("vibe_description")
  preferencesHash String   @map("preferences_hash")
  generatedAt     DateTime @map("generated_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("area_recommendations")
  @@schema("housing")
}

enum ViewingStatus {
  SCHEDULED
  COMPLETED
  CANCELLED

  @@map("viewing_status")
  @@schema("housing")
}

model Viewing {
  id          String        @id @default(uuid())
  listingId   String        @map("listing_id")
  userId      String        @map("user_id")
  scheduledAt DateTime      @map("scheduled_at")
  notes       String?
  status      ViewingStatus @default(SCHEDULED)
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("viewings")
  @@schema("housing")
}

model DismissedArea {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  areaName  String   @map("area_name")
  reason    String?
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, areaName])
  @@map("dismissed_areas")
  @@schema("housing")
}

model AreaNote {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  areaName  String   @map("area_name")
  liked     String?
  disliked  String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, areaName])
  @@map("area_notes")
  @@schema("housing")
}
